@using CompData.Models.Library;
@{
    //var data = Model.FirstOrDefault();
    //ViewData["Title"] = "Type - " + data.FullName;

    var detailTag = ViewBag.DetailTag as List<TagMap>;
    var bussinessLineTag = ViewBag.BussinessLineTag as List<TagMap>;
}

@section Styles {

    <link href="~/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
    <style>
        .table-scrollable {
            border: none !important;
        }

        .regulation-title {
            float: left;
            background: #fff;
            padding-right: 10px;
        }

        .ln {
            border-bottom: 1px dotted;
            margin-top: 10px;
        }
    </style>
}

<!-- BEGIN PAGE HEAD-->
<div class="page-head">
    <div class="container">
        <!-- BEGIN PAGE TITLE -->
        <div class="page-title">
            <ul class="page-breadcrumb breadcrumb">
                <li>
                    <a href="/">Home</a>
                    <i class="fa fa-circle"></i>
                </li>
                @*<li>
                        <a href="/Library/Source/@data.SourceId">@data.FullName</a>
                        <i class="fa fa-circle"></i>
                    </li>
                    <li>
                        <span>@data.FullName - @data.TypeName</span>
                    </li>*@
            </ul>
            <h3>
                @*@data.TypeName*@
            </h3>
        </div>
        <!-- END PAGE TITLE -->
    </div>
</div>
<!-- END PAGE HEAD-->
<!-- BEGIN PAGE CONTENT BODY -->
<div class="page-content">
    <div class="container">
        <!-- BEGIN PAGE CONTENT INNER -->
        <div class="page-content-inner">
            <div class="search-page search-content-2">
                <div class="row">
                    <div class="col-md-8 portlet light ">
                        <div class="search-container ">
                            <table id="tbType">
                                <thead style="display: none">
                                    <tr>
                                        <th style="width: 90%;"> Regulation Title </th>
                                        <th> Issue Date </th>
                                    </tr>
                                </thead>
                                @*<tbody>
                                        @foreach (var item in Model)
                                        {
                                            <tr>
                                                <td style="width: 80%;">
                                                    <a href="/Library/Regulation/@item.RegId"><div class="regulation-title">@item.RegulationTitle</div><div class="ln"></div></a>
                                                </td>
                                                <td class="center" style="text-align: center;">@item.IssueDate.ToString("dd MMM yyyy")</td>
                                            </tr>
                                        }
                                    </tbody>*@
                            </table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- BEGIN PORTLET-->
                        <div class="portlet light ">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-edit font-dark"></i>
                                    <span class="caption-subject font-dark bold uppercase">Search Within Current Section</span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Enter Search Terms Here" id="txtSearchTerms">
                                </div>
                            </div>
                        </div>
                        <!-- END PORTLET-->
                        <!-- BEGIN PORTLET-->
                        <div class="portlet light ">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-edit font-dark"></i>
                                    <span class="caption-subject font-dark bold uppercase">Filter by Period</span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="form-group">
                                    <div class="btn-group" data-period data-toggle="buttons">
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2020" class="toggle"> 2020
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2019" class="toggle"> 2019
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2018" class="toggle"> 2018
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2017" class="toggle"> 2017
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2016" class="toggle"> 2016
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2015" class="toggle"> 2015
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2014" class="toggle"> 2014
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="2013" class="toggle"> 2013
                                        </label>
                                        <label class="btn btn-default">
                                            <input type="checkbox" data-year value="-1" class="toggle"> Older
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END PORTLET-->
                        <!-- BEGIN PORTLET-->
                        <div class="portlet light ">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-edit font-dark"></i>
                                    <span class="caption-subject font-dark bold uppercase">Filter by Business Line</span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="btn-group" data-period data-toggle="buttons">
                                    @if (bussinessLineTag.Count() > 0)
                                    {
                                        @foreach (var tag in bussinessLineTag.Select(x => x.Tag).Distinct())
                                        {
                                            <label class="btn btn-default">
                                                <input type="checkbox" data-bussinessLine value="@tag" class="toggle"> @tag
                                            </label>
                                        }
                                    }
                                    else
                                    {
                                        <p>No Tag Linked</p>
                                    }
                                </div>
                            </div>
                        </div>
                        <!-- END PORTLET-->
                        <!-- BEGIN PORTLET-->
                        <div class="portlet light ">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-edit font-dark"></i>
                                    <span class="caption-subject font-dark bold uppercase">Filter by Tags</span>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="btn-group" data-period data-toggle="buttons">
                                    @if (detailTag.Count() > 0)
                                    {
                                        @foreach (var tag in detailTag.Select(x => x.Tag).Distinct())
                                        {
                                            <label class="btn btn-default">
                                                <input type="checkbox" data-detail value="@tag" class="toggle"> @tag
                                            </label>
                                        }
                                    }
                                    else
                                    {
                                        <p>No Tag Linked</p>
                                    }
                                </div>
                            </div>
                        </div>
                        <!-- END PORTLET-->
                    </div>
                </div>
            </div>
        </div>
        <!-- END PAGE CONTENT INNER -->
    </div>
</div>
<!-- END PAGE CONTENT BODY -->

@section Scripts {
    <script src="~/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <script src="~/assets/pages/scripts/table-datatables-managed.min.js" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            initDatatable()
        });
        //$('[data-detail]:checked')
        function initDatatable() {

            var searchTerm = $('#txtSearchTerms').val();
            var detailTag = (@detailTag.Count() > 0 ? Array.from($('[data-detail]:checked').map(function () { return $(this).val() })) : []);
            var bussinessLineTag = (@bussinessLineTag.Count() > 0 ? Array.from($('[data-bussinessLine]:checked').map(function () { return $(this).val() })) : []);
            var years = Array.from($('[data-year]:checked').map(function () { return $(this).val() }));

                $('#tbType').DataTable({
                "lengthChange": false,
                "searching": false,
                "pageLength": 25,
                "bJQueryUI": false,
                "dom": "lfrtip",
                "pagingType": "full_numbers",
                "serverSide": true,
                "processing": true,
                "ordering": true,
                "paging": true,
                "destroy": true,
                "autoWidth": false,
                "searchDelay": "800",
                "oLanguage": {
                    "search": "<span>Search:</span> ",
                    "info": "Showing <span>_START_</span> to <span>_END_</span> of <span>_TOTAL_</span> entries",
                    "lengthMenu": "_MENU_ <span>entries per page</span>"
                },
                "ajax": {
                    "type": "POST",
                    "url": "/Library/SourceGrid/",
                    "data": {
                        SourceId: @ViewBag.SourceId,
                        TypeId: @ViewBag.TypeId,
                        SearchTerm: searchTerm,
                        DetailTags: detailTag,
                        BussinessLineTags: bussinessLineTag,
                        Years: years
                    },
                    "dataSrc": function (json) {
                        console.log(json);
                        //if (json.recordsTotal == 0) _$.Notification('No record found !!!', 200);
                        return json.data;
                    }
                },
                "columns": [
                    { "data": "regulationTitle" },
                    { "data": "issueDate" },
                    { "data": "regId" },
                ],
                "columnDefs": [
                    {
                        orderable: false,
                        targets: 0,
                        render: function (data, type, full, meta) {
                            return '<a href="/Library/Regulation/' + full.regId + '"><div class="regulation-title">' + full.regulationTitle + '</div><div class="ln"></div></a>';
                        }
                    },
                    {
                        orderable: false,
                        targets: 1,
                        render: function (data, type, full, meta) {
                            return '<div style="text-align:center">' + full.issueDate + '</div>';
                        }
                    },
                    {
                        targets: 2,
                        visible: false
                    }
                ]
            });

        }

        $('[data-detail]').change(function () {
            initDatatable();
        });

        $('[data-year]').change(function () {
            initDatatable();
        });

        $('[data-bussinessLine]').change(function () {
            initDatatable();
        });

        $('#txtSearchTerms').change(function () {
            initDatatable();
        });
    </script>
}